'use strict';

angular.module('tripPlannerApp')
  .controller('CalendarCtrl', function($scope, planData, $http, $stateParams) {
    // Check to see if it's currently Daylight Savings Time
    var today = new Date();
    var dst = false;
    
    // This function on the prototype calculates the time offset as if we were in Jan and as if we were in July
    // Then, it returns whichever one is greater. If neither is greater than that place doesn't have DST.
    Date.prototype.stdTimezoneOffset = function() {
        var jan = new Date(this.getFullYear(), 0, 1);
        var jul = new Date(this.getFullYear(), 6, 1);
        return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
    }

    // This function compares the greater time offset (either Jan or Jul offset) to the current offset
    // if the current timezone offset from today is less than the greater timezone offset of Jan or Jul,
    // then we are on DST
    Date.prototype.dst = function() {
        return this.getTimezoneOffset() < this.stdTimezoneOffset();
    }

    if (today.dst()) { 
      var dst = true; 
    }

    // This function is called on date objects and will subtract one hour if DST is true.
    // If it's not true, it'll just return the date object
    Date.prototype.adjustDST = function() {
      if(dst) {
        return new Date(this.setHours(this.getHours() - 1));
      } else {
        return this;
      }
    }

    $scope.init = function() {
      $scope.updatePlanData();
    }

    // set the current trip and the populate events array
    var tripId = $stateParams.id;
    $scope.currentTrip = planData.getCurrentTrip();
    $scope.events = [];

    $scope.updatePlanData = function() {
      $http.get('/api/trips/' + tripId).success(function(trip) {
        planData.setCurrentTrip(trip);
        $scope.currentTrip = planData.getCurrentTrip();
        $scope.events = $scope.currentTrip.activities;
        $scope.eventSources[0] = $scope.events.map(function(event) {
          var start = event.start;
          var end;
          if(event.end) {
            end = event.end
          } else {
            end = new Date(start.setHours(start.getHours() + 1)).adjustDST();
          }
          // console.log("event start string:", event.start);
          // console.log("event start new date:", new Date(event.start));

          // var start = new Date(event.start);
          // var end = new Date(new Date(event.start).setHours(new Date(event.start).getHours() + 1));

          var obj = {
            title: event.title,
            start: start,
            end: end,
            allDay: false,
            id: event.googleDetails.place_id,
            timezone:'UTC'
          };
          return obj;
        });
      });
    };

    if (!planData.getCurrentTrip()) {
      $scope.updatePlanData();
    }

    $scope.$on('addToCal', function() {
      $scope.updatePlanData();
    });

    $scope.updateActivities = function(event) {
      for(var i=0, n=$scope.events.length; i<n; i++) {
        if($scope.events[i].googleDetails.place_id == event.id) {
          
          var start = new Date($scope.events[i].start);
          $scope.events[i].start = event.start.toUTCString();

          if(event.end) {
            $scope.events[i].end = event.end.toUTCString();
          } else {
            var end = new Date(start.setHours(start.getHours() + 1));
            $scope.events[i].end = new Date(end).toUTCString();
          }
        }
      }

      $http.post('/api/trips/' + tripId, {
        activities: $scope.events
      }).success(function(updatedTrip) {
        planData.setCurrentTrip(updatedTrip);
      })
    }

    $scope.deleteActivity = function(event) {
      console.log('the delete button has been clicked', event);
      for(var i = 0; i < $scope.events.length; i++) {
        if($scope.events[i].googleDetails.place_id == event._id && $scope.events[i].start == event.start.toUTCString()) {

          $scope.events.splice(i, 1);
          $scope.updatePlanData();
          $scope.deletePanel = !$scope.deletePanel;
          break;
        }
      }
      console.log('events',$scope.events);
      $http.post('/api/trips/' + tripId, {
        activities: $scope.events
      }).success(function(updatedTrip) {
        planData.setCurrentTrip(updatedTrip);
      })
    }

    //with this you can handle the events that generated by clicking the day(empty spot) in the calendar
    $scope.dayClick = function(date, allDay) {
      $scope.$apply(function() {
        console.log('Day Clicked ' + date);
      });
    };

    //with this you can handle the events that generated by dropping any event to different position in the calendar
    $scope.alertOnDrop = function(event) {
      $scope.$apply(function() {
        $scope.updateActivities(event);
      });
    };


    //with this you can handle the events that generated by resizing any event to different position in the calendar
    $scope.alertOnResize = function(event) {
      $scope.$apply(function() {
        $scope.updateActivities(event);
      });
    };

    $scope.deletePanel = false;
    $scope.currentEvent = null;

    //with this you can handle the click on the events
    $scope.eventClick = function(event, allDay, jsEvent, view) {
      // $scope.$apply(function() {
        $scope.currentEvent = event;
        $scope.deletePanel = !$scope.deletePanel;
      // });
    };

    /* config object */
    $scope.uiConfig = {
      calendar: {
        // height: 450,
        editable: true,
        header: {
          left: 'month agendaWeek agendaDay',
          center: 'title',
          right: 'today prev,next'
        },
        dayClick: $scope.dayClick,
        eventDrop: $scope.alertOnDrop,
        eventResize: $scope.alertOnResize,
        eventClick: $scope.eventClick,
        viewRender: $scope.renderView,
        ignoreTimezone:false,
        currentTimezone: false
      },
      currentTimezone: false
    };

    /* event sources array*/
    $scope.eventSources = [$scope.events];
    console.log("scope eventsorces:", $scope.eventSources);

    $scope.init();
  });


// /* Change View */
// this.changeView = function(view,calendar) {
//   calendar.fullCalendar('changeView',view);
// };

// /* Change View */
// this.renderCalender = function(calendar) {
//   if(calendar){
//     calendar.fullCalendar('render');
//   }
// };

